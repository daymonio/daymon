name: Test Windows Code Signing

on:
  workflow_dispatch:

jobs:
  test-credentials:
    runs-on: ubuntu-latest
    steps:
      - name: Test SSL.com API login
        run: |
          echo "=== Testing SSL.com OAuth login ==="
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "https://login.ssl.com/oauth2/token" \
            -d "grant_type=client_credentials" \
            -d "client_id=${{ secrets.ES_USERNAME }}" \
            -d "client_secret=${{ secrets.ES_PASSWORD }}")
          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          BODY=$(echo "$RESPONSE" | head -n -1)
          echo "HTTP Status: $HTTP_CODE"
          echo "Response: $BODY"
          if [ "$HTTP_CODE" = "200" ]; then
            echo "✅ Login successful!"
          else
            echo "❌ Login failed"
            exit 1
          fi

      - name: Test TOTP generation
        run: |
          pip install pyotp -q
          python3 -c "
          import pyotp
          secret = '${{ secrets.ES_TOTP_SECRET }}'
          totp = pyotp.TOTP(secret)
          code = totp.now()
          print(f'TOTP code generated: {code[:2]}****')
          print('✅ TOTP secret is valid')
          " || echo "❌ TOTP secret is invalid"

      - name: Test credential ID format
        run: |
          CRED_ID="${{ secrets.ES_CREDENTIAL_ID }}"
          if [[ "$CRED_ID" =~ ^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$ ]]; then
            echo "✅ Credential ID format is valid UUID: ${CRED_ID:0:8}..."
          else
            echo "❌ Credential ID is not a valid UUID"
            exit 1
          fi
